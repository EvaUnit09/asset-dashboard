name: Deploy to asset server

on:
  push:
    branches: [main]

jobs:
  build-deploy:
    runs-on: [self-hosted, windows, asset]
    defaults:
      run:
        shell: powershell

    steps:
    # 1 Make Git trust the workspace -------------------------------------------------
    - name: Trust workspace for Git
      shell: cmd
      run: git config --system --add safe.directory "E:/actions-runner/_work/asset-dashboard/asset-dashboard"

    # 2 Check out code ---------------------------------------------------------------
    - uses: actions/checkout@v4
      with:
        clean: true          # or path: src  (see fix ➋)

    # 3 Copy Zscaler CA so Node / pip can use it ------------------------------------
    - name: Add corporate CA bundle
      shell: powershell
      run: |
        Copy-Item 'E:\actions-runner\ZscalerRootCA.crt' 'E:\actions-runner\ca-bundle.pem' -Force
        

    # ---------- Front-end ----------
    - name: Set up Node
      uses: actions/setup-node@v4
      env:
        NODE_EXTRA_CA_CERTS: E:\actions-runner\ca-bundle.pem
        REQUESTS_CA_BUNDLE: E:\actions-runner\ca-bundle.pem
        PIP_CERT: E:\actions-runner\ca-bundle.pem
      with:
        # use an available version (20 LTS today) —
        # change to 24.x once setup-node supports it
        node-version: '20'

    - name: Install dependencies & build
      working-directory: frontend
      env:
        NODE_EXTRA_CA_CERTS: E:\actions-runner\ca-bundle.pem
        REQUESTS_CA_BUNDLE: E:\actions-runner\ca-bundle.pem
        PIP_CERT: E:\actions-runner\ca-bundle.pem
      run: |
        npm ci
        npm run build

    - name: Deploy static files to IIS site
      run: |
        robocopy frontend\dist E:\asset-app\site\dist /MIR
        if ($LASTEXITCODE -le 7) { exit 0 }  # 0-7 = success/warning
        exit $LASTEXITCODE                    # 8+ = fail the job

    # ---------- Back-end ----------
    - name: Set up Python
      uses: actions/setup-python@v5
      env:
        NODE_EXTRA_CA_CERTS: E:\actions-runner\ca-bundle.pem
        REQUESTS_CA_BUNDLE: E:\actions-runner\ca-bundle.pem
        PIP_CERT: E:\actions-runner\ca-bundle.pem
      with:
        python-version: '3.12'

    - name: Install backend requirements (venv)
      working-directory: backend
      run: |
        E:\asset-app\backend\.venv\Scripts\python.exe -m pip install --upgrade pip
        E:\asset-app\backend\.venv\Scripts\pip.exe install -r requirements.txt

    - name: Copy backend files
      run: |
        robocopy backend E:\asset-app\backend /MIR /XD __pycache__ /XF *.pyc
        if ($LASTEXITCODE -le 7) { exit 0 }
        exit $LASTEXITCODE

    - name: Create .env from secrets
      run: |
        echo DATABASE_URL=${{ secrets.MYSECRETS_DATABASE_URL }} > E:\asset-app\backend\.env
        echo SNIPEIT_API_URL=${{ secrets.MYSECRETS_SNIPEIT_API_URL }} >> E:\asset-app\backend\.env
        echo SNIPEIT_TOKEN=${{ secrets.MYSECRETS_SNIPEIT_TOKEN }} >> E:\asset-app\backend\.env
        echo REQUESTS_CA_BUNDLE=E:\asset-app\backend\certs\ZscalerRootCA.pem >> E:\asset-app\backend\.env

    - name: Copy Zscaler cert
      run: |
        mkdir E:\asset-app\backend\certs 2>nul
        copy E:\actions-runner\ZscalerRootCA.crt E:\asset-app\backend\certs\ZscalerRootCA.pem

    # ---------- Restart service ----------
    - name: Restart AssetBackend service
      run: |
        nssm restart AssetBackend
      continue-on-error: true

