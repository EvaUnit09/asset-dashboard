name: Deploy to asset server

on:
  push:
    branches: [main]

jobs:
  build-deploy:
    runs-on: [self-hosted, windows, asset]
    defaults:
      run:
        shell: powershell

    steps:
    # 1 Make Git trust the workspace -------------------------------------------------
    - name: Trust workspace for Git
      shell: cmd
      run: git config --system --add safe.directory "E:/actions-runner/_work/asset-dashboard/asset-dashboard"

    # 2 Check out code ---------------------------------------------------------------
    - uses: actions/checkout@v4
      with:
        clean: true          # or path: src  (see fix ➋)

    # 3 Copy Zscaler CA so Node / pip can use it ------------------------------------
    - name: Add corporate CA bundle
      run: |
        Copy-Item 'E:\actions-runner\ZscalerRootCA.crt' 'E:\actions-runner\ca-bundle.pem' -Force
        

    # ---------- Front-end ----------
    - name: Set up Node
      uses: actions/setup-node@v4
      env:
        NODE_EXTRA_CA_CERTS: E:\actions-runner\ca-bundle.pem
        REQUESTS_CA_BUNDLE: E:\actions-runner\ca-bundle.pem
        PIP_CERT: E:\actions-runner\ca-bundle.pem
      with:
        # use an available version (20 LTS today) —
        # change to 24.x once setup-node supports it
        node-version: '20'

    - name: Install dependencies & build
      working-directory: frontend
      env:
        NODE_EXTRA_CA_CERTS: E:\actions-runner\ca-bundle.pem
        REQUESTS_CA_BUNDLE: E:\actions-runner\ca-bundle.pem
        PIP_CERT: E:\actions-runner\ca-bundle.pem
      run: |
        npm ci
        npm run build

    - name: Deploy static files to IIS site
      run: |
        robocopy frontend\dist E:\asset-app\site\dist /MIR
        if ($LASTEXITCODE -le 7) { exit 0 }  # 0-7 = success/warning
        exit $LASTEXITCODE                    # 8+ = fail the job

    # ---------- Back-end ----------
    - name: Set up Python
      uses: actions/setup-python@v5
      env:
        NODE_EXTRA_CA_CERTS: E:\actions-runner\ca-bundle.pem
        REQUESTS_CA_BUNDLE: E:\actions-runner\ca-bundle.pem
        PIP_CERT: E:\actions-runner\ca-bundle.pem
      with:
        python-version: '3.12'

    # Copy backend files FIRST (but exclude .venv and .env)
    - name: Copy backend files
      run: |
        robocopy backend E:\asset-app\backend /MIR /XD __pycache__ .venv /XF *.pyc .env
        if ($LASTEXITCODE -le 7) { exit 0 }
        exit $LASTEXITCODE

    # Create .env from single secret
    - name: Create .env from single secret
      run: |
        echo "${{ secrets.MYSECRETS }}" > E:\asset-app\backend\.env

    # Copy Zscaler cert
    - name: Copy Zscaler cert
      run: |
        New-Item -ItemType Directory -Path E:\asset-app\backend\certs -Force
        Copy-Item E:\actions-runner\ZscalerRootCA.crt E:\asset-app\backend\certs\ZscalerRootCA.pem

    # Remove old virtual environment
    - name: Remove old virtual environment
      run: |
        if (Test-Path E:\asset-app\backend\.venv) { 
          Remove-Item E:\asset-app\backend\.venv -Recurse -Force -ErrorAction SilentlyContinue 
        }

    # Create virtual environment
    - name: Create virtual environment
      run: |
        python -m venv E:\asset-app\backend\.venv

    # Install backend requirements (NOW requirements.txt is available)
    - name: Install backend requirements (venv)
      env:
        NODE_EXTRA_CA_CERTS: E:\actions-runner\ca-bundle.pem
        REQUESTS_CA_BUNDLE: E:\actions-runner\ca-bundle.pem
        PIP_CERT: E:\actions-runner\ca-bundle.pem
      run: |
        E:\asset-app\backend\.venv\Scripts\python.exe -m pip install --upgrade pip
        E:\asset-app\backend\.venv\Scripts\pip.exe install -r E:\asset-app\backend\requirements.txt

    # ---------- Restart service ----------
    - name: Restart AssetBackend service
      run: |
        nssm restart AssetBackend
      continue-on-error: true

